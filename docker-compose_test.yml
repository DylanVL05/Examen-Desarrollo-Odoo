# docker-compose.test.yml
version: '3.1'

services:
  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_USER=odoo
      - POSTGRES_PASSWORD=odoo
    volumes:
      - db-test-data:/var/lib/postgresql/data

  test:
    image: odoo:18.0
    depends_on:
      - db
    environment:
      - HOST=db
      - USER=odoo
      - PASSWORD=odoo
    volumes:
      - ./dev:/mnt/extra-addons
    command: >
      bash -c "
        echo '⏳ Esperando a que la base de datos esté lista...';
        until pg_isready -h db -U odoo > /dev/null 2>&1; do
          sleep 1;
        done;
        echo '✅ Base de datos disponible.';

        echo '🧪 Ejecutando pruebas del módulo odoo_dim_sales...';
        odoo -d demo_db --db_host=db --db_user=odoo --db_password=odoo \
             -i odoo_dim_sales --test-enable --stop-after-init
      "

volumes:
  db-test-data:

